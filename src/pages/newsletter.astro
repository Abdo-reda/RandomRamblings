---
import MainLayout from "../layouts/MainLayout.astro";
import { supabaseNewsletterService } from "../lib/clients/supabase";
import type { NotificationFrequency } from "../lib/enums/notificationFrequencyEnum";
import type { Theme } from "../lib/enums/themeEnum";
import type { INewsletterService } from "../lib/interfaces/newsletterServiceInterface";
import { isValidEmail, isValidNotification, isValidTheme } from "../lib/utilities/validationUtilities";

export const prerender = false;
const pageTitle = "Newsletter";
const newsLetterService: INewsletterService = supabaseNewsletterService;
const errors = { email: "", notification: "", theme: "" };

await newsLetterService.isAlreadySubscribed("3bdo.reda@gmail.com")

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const email = data.get("email");
    const notification = data.get("notification");
    const theme = data.get("theme");

    errors.email = "";
    errors.notification = "";

    if (typeof email !== "string" || !isValidEmail(email)) {
      errors.email = "Email is not valid. ";
    } else if (
      await newsLetterService.isAlreadySubscribed(email)
    ) {
      errors.email = "Email is already registered. ";
    }

    if (typeof notification !== "string" || !isValidNotification(notification)) {
      errors.notification = "Notification is not valid. ";
    }

    if (typeof theme !== "string" || !isValidTheme(theme)) {
      errors.theme = "Theme is not valid. ";
    }

    const hasErrors = Object.values(errors).some(msg => msg)
    
    if (hasErrors) return; 
 
    await newsLetterService.sendConfirmation({
      email: email as string,
      notification: notification as NotificationFrequency,
      theme: theme as Theme,
    })

    return Astro.redirect("/status/newsletter-send-success")
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    }
  }
}
---

<MainLayout pageTitle={pageTitle}>
  <div class="page-image">
    <!-- <Image src={logo} alt="logo." width={500} /> -->
  </div>
  <h1>Newsletter</h1>
  <fieldset>
    <legend>Subscription</legend>
    <div class="page-wrapper">
      <form class="simple-form" method="POST">
        <div class="input-wrapper">
          <label for="email">Email</label>
          <input name="email" class="input" type="email" required />
        </div>
        <div>
          <label for="notification">Notification</label>
          <div class="radio-group">
            <div>
              <input
                class="radio"
                type="radio"
                id="weekly"
                name="notification"
                value="weekly"
                checked
              />
              <label for="weekly">Weekly</label>
            </div>

            <div>
              <input
                class="radio"
                type="radio"
                id="monthly"
                name="notification"
                value="monthly"
              />
              <label for="monthly">Monthly</label>
            </div>
          </div>
        </div>
        <div>
          <label for="theme">Theme</label>
          <div class="radio-group">
            <div>
              <input
                class="radio"
                type="radio"
                id="light"
                name="theme"
                value="light"
              />
              <label for="light">Light</label>
            </div>

            <div>
              <input
                class="radio"
                type="radio"
                id="dark"
                name="theme"
                value="dark"
              />
              <label for="dark">Dark</label>
            </div>
          </div>
        </div>
        <!-- <div class="input-wrapper">
          <label for="tags">Tags</label>
          <div class="tags-wrapper">
            {
              Object.values(TagEnum).map((tag) => (
                <span class="badge badge--item tag tag-button">
                  #{tag}
                </span>
              ))
            }
          </div>
        </div> -->
        <div class="button-wrapper">
          <button type="submit" class="btn"> Subscribe </button>
        </div>
      </form>
    </div>
  </fieldset>
</MainLayout>

<script>
  const theme = localStorage.getItem("theme");
  const radioElement = document.getElementById(theme ?? 'dark') as HTMLInputElement;
  radioElement.checked = true;
</script>